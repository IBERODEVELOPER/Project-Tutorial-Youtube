<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="main/layout.html :: head"></head>
<body>
	<div class="container-fluid vh-100 d-flex align-items-center justify-content-center">
	  <div class="row w-75 shadow-lg rounded-4 overflow-hidden" style="height: 600px;">

	    <!-- Imagen -->
	    <div class="col-md-6 p-0 d-none d-md-block">
	      <img th:src="@{/images/login-image.jpg}" alt="Imagen Login" class="img-fluid h-80 w-100" style="object-fit: cover;">
	    </div>

	    <!-- Formulario -->
	    <div class="col-md-6 bg-light d-flex align-items-center justify-content-center">
	      <form  th:action="@{/login}" class="w-75" method="post">
	        <h2 class="mb-4 text-center">Inicio de Sesión</h2>
			
			<!-- Mensaje de error -->
			<div th:if="${error}" class="alert alert-danger text-center">
			    <span th:text="${error}"></span>
			</div>

			<!-- Mensaje de logout -->
			<div th:if="${mensajeout}" class="alert alert-success text-center">
			    <span th:text="${mensajeout}"></span>
			</div>
			<!-- Mensaje de success -->
				<div th:if="${sucess}" class="alert alert-success text-center">
					<span th:text="${sucess}"></span>
				</div>
	        <div class="mb-3">
	          <label for="username" class="form-label">Usuario</label>
	          <input type="text" id="username" name="username" class="form-control" placeholder="Username" required autofocus>
	        </div>

	        <div class="mb-3">
	          <label for="password" class="form-label">Contraseña</label>
	          <input type="password" id="password" name="password" class="form-control" placeholder="Password" required>
	        </div>

	        <input type="hidden" name="_csrf" th:value="${_csrf.token}" />
			<div style="text-align: right;">
				<a href="#" class="" data-bs-toggle="modal" data-bs-target="#recoverPasswordModal"> Recuperar Contraseña </a>
			</div>

	        <button class="btn btn-primary w-100" type="submit">Ingresar</button>
	      </form>
		  
		  <!-- Modal de Recuperación de Contraseña -->
			<div class="modal fade" id="recoverPasswordModal" tabindex="-1" aria-labelledby="recoverPasswordModalLabel" aria-hidden="true">
				 <div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title" id="recoverPasswordModalLabel">Recuperar Contraseña</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
			
			<div class="modal-body">
				<form id="recoverForm">
					<div class="mb-3">
						<label for="email" class="form-label">Correo Electrónico</label>
						<input type="email" class="form-control" id="email" name="email" placeholder="Ingrese su correo electrónico" required>
				    </div>
				    <button type="submit" class="btn btn-success">Enviar</button>
				</form>
			</div>
			
			<div class="modal-footer">
			 <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
			</div>
				</div>
			</div>
		</div><!-- Fin del Modal de Recuperación de Contraseña -->
		
		<!-- Modal: Verificar OTP -->
		<div
		class="modal fade" id="verifyOtpModal" tabindex="-1" 
		aria-labelledby="verifyOtpModalLabel" aria-hidden="true">
			
		  <div class="modal-dialog">
		    <div class="modal-content">
				
		      <div class="modal-header">
		        <h5 class="modal-title">Verificar Código OTP</h5>
		        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
		      </div>
			  
		      <div class="modal-body">
		        <form  th:action="@{/validate-otp}" method="get" id="verifyOtpForm">
		          <div class="mb-3">
		            <label class="form-label">Código OTP</label>
					
					<div id="mensaje" class="alert alert-success text-center" style="display:none;">
					    <span id="mensajeTexto"></span>
					</div>
					
					<input type="hidden" name="_csrf" th:value="${_csrf.token}"/>
					<input type="hidden" id="userId" name="id" />
		            <input type="text" class="form-control" id="otp" name="otp" maxlength="6" required>
					
		          </div>
		          <button type="submit" class="btn btn-success">Verificar</button>
		        </form>
		      </div>
			  
		    </div>
		  </div>
		</div><!-- Fin del Modal Verificación -->
		
	    </div>

	  </div>
	</div>
	<footer th:replace="main/layout.html :: footer"></footer>
	<script>
		document.getElementById("recoverForm").addEventListener("submit", function(e) {
				    e.preventDefault();
				    let email = document.getElementById("email").value;
					
					let token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
					let header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
						
				    fetch("/send-email", {
				        method: "POST",
				        headers: { 
							"Content-Type": "application/x-www-form-urlencoded",
							[header]: token
						},
				        body: "email=" + encodeURIComponent(email)
				    })
				    .then(res => res.json().then(data => {
				        return { ok: res.ok, data }; // devolvemos el estado y el JSON
				    }))
				    .then(result => {
				        if (result.ok && result.data.success) {
							
							document.getElementById('userId').value = result.data.userId;
							
							if (document.activeElement) {
							        document.activeElement.blur();
							    }
				            // Cierra el primer modal
				            let recoverModal = bootstrap.Modal.getInstance(document.getElementById("recoverPasswordModal"));
				            recoverModal.hide();

				            // Abre el segundo modal
							document.getElementById("recoverPasswordModal").addEventListener('hidden.bs.modal', function () {
							    let otpModal = new bootstrap.Modal(document.getElementById("verifyOtpModal"));
								console.log("ID :", result.data.userId);
							    otpModal.show();

							    // Cuando el segundo modal esté visible
							    document.getElementById("verifyOtpModal").addEventListener('shown.bs.modal', function () {
									document.getElementById("mensajeTexto").innerText = result.data.message;
							        document.getElementById("mensaje").style.display = "block";
							    }, { once: true });

							}, { once: true });
								
				        } else {
				            alert(result.data.message);
				        }
				    })
				    .catch(err => console.error("Error:", err));
				});
	</script>
</body>
</html>